# dcplaya  - developer auto documentation - Makefile
#
# (C) COPYRIGHT 2002 Ben(jamin) Gerard  <ben@sashipa.com>
#
# $Id: Makefile.in,v 1.10 2003-03-14 18:44:38 ben Exp $
#

VERSION = @VERSION@
DOXYGEN = "@DOXYGEN@"

ALL_HEADERS		:= $(shell find .. -type f -name '*.h')
ALL_HEADERS_PATH	:= $(sort . $(dir $(ALL_HEADERS)))

HINFILES		:= $(wildcard *.hin)
DEVDOCFILES		:= $(HINFILES:%.hin=%.h)

LUADOCDIR    := lua_doc
LUASRCDIR    := ..

LUAALLFILES  :=\
 $(wildcard $(LUASRCDIR)/*.lua)\
 $(wildcard $(LUASRCDIR)/lua/*.lua)
LUASRCFILES  := $(LUAALLFILES:$(LUASRCDIR)/%=%)
LUADOCFILES := $(addprefix $(LUADOCDIR)/,$(LUASRCFILES:%.lua=%.lua) doc.lua) 

DOCINPUTS=$(ALL_HEADERS_PATH) $(LUADOCDIR) $(LUADOCDIR)/lua

SHASUBST=../utils/shasubst.sh
LUA2DOX=../utils/lua2dox.sh

vpath
vpath %.h $(ALL_HEADERS_PATH)
vpath %.lua .. ../lua

# Build shasubst definition
#
DATE	:= $(shell date +"%B %Y")

# doxygene global configuration
###################################################

DOXALL	:= -D date="$(DATE)"
DOXALL	+= -D dox-version=$(VERSION)
DOXALL	+= -D dox-project="dcplaya"
DOXALL	+= -D dox-file-patterns='*.h *.lua'
DOXALL	+= -D dox-quiet=NO
DOXALL	+= -D dox-warnings=YES
DOXALL	+= -D dox-extract-all=NO
DOXALL	+= -D dox-private=NO
DOXALL	+= -D dox-source-browser=NO
DOXALL  += -D dox-javadoc_autobrief=yes
DOXALL  += -D distribute_group_doc=yes
DOXALL  += -D optimize_output_for_c=yes
DOXALL	+= -D dox-tab-size=12
DOXALL	+= -D dox-destination=.
DOXALL	+= -D dox-preprocessing=YES
DOXALL	+= -D dox-macro_expansion=YES
DOXALL	+= -D dox-sort-member-docs=NO
DOXALL	+= -D dox-recursive=NO
DOXALL	+= -D dox-alphabetical-index=NO
DOXALL	+= -D dox-internal-docs=NO

# DEVELOPER DOCUMENTATION
###################################################

DOXDEV	:=
DOXDEV	+= -D dox-input="$(DOCINPUTS)"
DOXDEV	+= -D dox-predefined="DEBUG"
DOXDEV	+= -D dox-include_path=..
DOXDEV	+= -D dox-optimize-output-for-c=YES
DOXDEV	+= -D dox-enabled-sections=""
DOXDEV	+= -D dox-generate-html=YES
DOXDEV	+= -D dox-html-header=
DOXDEV	+= -D dox-html-footer=
DOXDEV	+= -D dox-html-stylesheet=dcplaya_doc.css
DOXDEV	+= -D dox-generate-treeview=NO
DOXDEV	+= -D dox-generate-man=NO
DOXDEV	+= -D dox-man-extension=.1
DOXDEV	+= -D dox-generate-latex=NO

# MAKE RULES
###################################################

all: Makefile devdoc

Makefile : Makefile.in
	(cd ..; ./config.status) 

$(LUADOCDIR)/doc.lua : luadoc.h
	cp -f $< $@

$(LUADOCDIR)/%.lua : %.lua Makefile
	@echo "make [$@] from [$<]"
	@mkdir -p $(dir $@)
	@$(LUA2DOX) < $< > $@
	@[ -s $@ ] || echo "/// @file $(@F)" > $@

luadoc: $(LUADOCFILES)

devdoc: devdoc.dox $(DEVDOCFILES) luadoc
	$(DOXYGEN) $<

devdoc.dox: generic.doxin Makefile
	cat $< | grep -E -v '^#.*$$' |\
	grep -E -v '^ *$$' |\
	$(SHASUBST) $(DOXALL) $(DOXDEV) > $@

%.h : %.hin
	cat $< > $@

clean_local:
	@rm -f *.dox *.h *~

clean: clean_local
	@rm -rf html latex man `find . -type f -name '*.lua'`

distclean: clean
	@rm -f Makefile *~

dep depend depend-clean:

required:
	@mkdir -p "$(LUADOCDIR)"

