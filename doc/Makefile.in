# dcplaya  - developer auto documentation - Makefile
#
# (C) COPYRIGHT 2002 Ben(jamin) Gerard  <ben@sashipa.com>
#
# $Id: Makefile.in,v 1.13 2003-03-19 05:16:15 ben Exp $
#

VERSION = @VERSION@
DOXYGEN = "@DOXYGEN@"

#ALL_HEADERS		:= $(shell find .. -type f -name '*.h')
#ALL_HEADERS_PATH	:= $(sort . $(dir $(ALL_HEADERS)))

PLG_HEADERS	:= $(shell find ../plugins -maxdepth 3 -type f -name '*.h')
PLG_HEADERS_PATH	:= $(sort . $(dir $(PLG_HEADERS)))


PLUG_TOP = ../plugins
PLUG_DIR = exe img inp vis


ALL_HEADERS_PATH := . \
 ../include \
 ../libs/draw \
 ../libs/translator \
 ../libs/translator/SHAsys \
 ../libs/translator/SHAtk \
 ../libs/translator/SHAR \
 ../libs/translator/SHAwrapper \
 ../libs/translator/SHAtranslator \
 ../libs/translator/SHAblitter \
 $(PLG_HEADERS_PATH)
# $(foreach i,$(PLUG_DIR),$(PLUG_TOP)/$(i))

# Local doc files
HINFILES		:= $(wildcard *.hin)
DEVDOCFILES		:= $(HINFILES:%.hin=%.h)

HTML_EXTRA	:= dcplaya_doc.css dcplaya_header.html dcplaya_footer.html 

DOC_DIR 	:= doc
LUADOCDIR	:= lua_doc
LUASRCDIR	:= ..

LUAALLFILES  :=\
 $(wildcard $(LUASRCDIR)/*.lua)\
 $(wildcard $(LUASRCDIR)/lua/*.lua)
LUASRCFILES  := $(LUAALLFILES:$(LUASRCDIR)/%=%)
LUADOCFILES := $(addprefix $(LUADOCDIR)/,$(LUASRCFILES:%.lua=%.lua) doc.lua) 

DOCINPUTS=$(ALL_HEADERS_PATH) $(LUADOCDIR) $(LUADOCDIR)/lua

SHASUBST=../utils/shasubst.sh
LUA2DOX=../utils/lua2dox.sh

vpath
vpath %.h $(ALL_HEADERS_PATH)
vpath %.lua .. ../lua

# Build shasubst definition
#
DATE	:= $(shell date +"%B %Y")

# style sheet configuration
###################################################
CSS	:=
CSS	+= -D "background=\#c4bdac"
#808080"
CSS	+= -D "text=\#59564e"

CSS	+= -D "font-family=arial, tahoma, verdana, sans-serif"
CSS	+= -D "font-size=12pt"
CSS	+= -D "font-weight=normal"

CSS	+= -D "anchor-color=\#000000"
#CSS	+= -D "anchor-color=\#e0e0e0"
CSS	+= -D "hi-color=\#FFFFFF"

CSS	+= -D "barcolor=\#a0937b"
CSS	+= -D "barcolorlight=\#b7a88d"
#e59900"
CSS	+= -D "bartext=\#000000"
CSS	+= -D "barborder=1px solid"
CSS	+= -D "barbordercolor=\#000000"

CSS	+= -D "code-text=\#59564e"
CSS	+= -D "keyword=\#04708e"
CSS	+= -D "keywordtype=\#035066"
CSS	+= -D "keywordflow=\#704000"
CSS	+= -D "comment=\#A05020"
CSS	+= -D "preprocessor=\#404080"
CSS	+= -D "stringliteral=\#307030"
CSS	+= -D "charliteral=\#307030"

# doxygene global configuration
###################################################

DOXALL	:= -D date="$(DATE)"
DOXALL	+= -D dox-version=$(VERSION)
DOXALL	+= -D dox-project="dcplaya"
DOXALL	+= -D dox-file-patterns='*.h *.lua'
DOXALL	+= -D dox-quiet=NO
DOXALL	+= -D dox-warnings=YES
DOXALL	+= -D dox-extract-all=NO
DOXALL	+= -D dox-private=NO
DOXALL	+= -D dox-source-browser=NO
DOXALL  += -D dox-javadoc_autobrief=yes
DOXALL  += -D distribute_group_doc=yes
DOXALL  += -D optimize_output_for_c=yes
DOXALL	+= -D dox-tab-size=12
DOXALL	+= -D dox-destination=$(DOC_DIR)
DOXALL	+= -D dox-preprocessing=YES
DOXALL	+= -D dox-macro_expansion=YES
DOXALL	+= -D dox-sort-member-docs=NO
DOXALL	+= -D dox-recursive=NO
DOXALL	+= -D dox-alphabetical-index=NO
DOXALL	+= -D dox-internal-docs=NO

# DEVELOPER DOCUMENTATION
###################################################

DOXDEV	:=
DOXDEV	+= -D dox-input="$(DOCINPUTS)"
DOXDEV	+= -D dox-predefined="DEBUG"
DOXDEV	+= -D dox-include_path=..
DOXDEV	+= -D dox-optimize-output-for-c=YES
DOXDEV	+= -D dox-enabled-sections=""
DOXDEV	+= -D dox-generate-html=YES
ifeq "$(strip $(MAKECMDGOALS))" "xml"
DOXDEV	+= -D dox-generate-xml=YES
else
DOXDEV	+= -D dox-generate-xml=NO
endif
DOXDEV	+= -D dox-html-header=dcplaya_header.html
DOXDEV	+= -D dox-html-footer=dcplaya_footer.html
DOXDEV	+= -D dox-html-stylesheet=dcplaya_doc.css
DOXDEV	+= -D dox-generate-treeview=NO
DOXDEV	+= -D dox-generate-man=NO
DOXDEV	+= -D dox-man-extension=.1
DOXDEV	+= -D dox-generate-latex=NO

# MAKE RULES
###################################################


all: Makefile devdoc
xml: all
txt: all txt_only

txt_only:
	mkdir -p $(DOC_DIR)/text
	for i in `find $(DOC_DIR)/html -type f -name '*.html'`; do lynx -dump $$i > $(DOC_DIR)/text/`basename $$i .html`.txt ; done


Makefile : Makefile.in
	(cd ..; ./config.status) 

$(LUADOCDIR)/doc.lua : luadoc.h
	cp -f $< $@

$(LUADOCDIR)/%.lua : %.lua Makefile
	@echo "make [$@] from [$<]"
	@mkdir -p $(dir $@)
	@$(LUA2DOX) < $< > $@
	@[ -s $@ ] || echo "/// @file $(@F)" > $@

luadoc: $(LUADOCFILES)

devdoc: devdoc.dox $(DEVDOCFILES) luadoc $(HTML_EXTRA)
	$(DOXYGEN) $<

devdoc.dox: generic.doxin Makefile
	cat $< | grep -E -v '^#.*$$' |\
	grep -E -v '^ *$$' |\
	$(SHASUBST) $(DOXALL) $(DOXDEV) > $@

%.html : %.htmlin Makefile
	$(SHASUBST) $(DOXALL) < $< > $@

%.css : %.cssin Makefile
	$(SHASUBST) $(CSS) < $< > $@

%.h : %.hin Makefile
	cat $< > $@

clean_local:
	@rm -f *.dox *.h *~ *.html *.css *.lua

clean: clean_local
	@rm -rf $(foreach i, html xml man text latex,$(DOC_DIR)/$(i)) $(LUADOCDIR)

distclean: clean
	@rm -f Makefile *~

dep depend depend-clean:

required:
	mkdir -p "$(LUADOCDIR)" "$(DOC_DIR)"
